@model RegistroDoc.Models.InvIndexViewModel

@{
    ViewData["Title"] = "Index";
}

<h1>Inventario</h1>

<p>
    <a asp-action="Create">Adicionar Nuevo Documento</a>
</p>
<h5 style="color: red">@TempData["ErrorMsg"]</h5>
<div class="demo-container">
    <div id="inventoryGrid"></div>
</div>

<div id="MovementModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Registrar Movimiento</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <form asp-action="Create" asp-controller="Movements" method="post">
                            <div class="col-xs-12">
                                <div class="form-group">
                                    <label asp-for="Movement.MovementObservation" class="control-label"></label>
                                    <input asp-for="Movement.MovementObservation" class="form-control" />
                                    <span asp-validation-for="Movement.MovementObservation" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <div class="form-group">
                                    <input type="submit" value="Guardar" class="btn btn-default" />
                                </div>
                            </div>
                            <input asp-for="Movement.InventoryId" hidden value="0">
                            <input asp-for="Movement.MovementType" hidden value="">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{

    <script>

    $.ajax({
        url: '@Url.Action("LoadGrid", "Inventory")',
        type: "GET"
    }).done(function (response) {

        var dataSourceMaster = response.master;
        var dataSourceDetail = response.detail;

        console.log(dataSourceMaster);
        console.log(dataSourceDetail);

        $(function(){
            $("#inventoryGrid").dxDataGrid({
                dataSource: dataSourceMaster,
                keyExpr: "inventoryId",
                allowColumnReordering: true,
                allowColumnResizing: true,
                columnAutoWidth: true,
                showColumnLines: true,
                showRowLines: true,
                rowAlternationEnabled: true,
                showBorders: true,
                columnChooser: {
                enabled: true
                },
                filterRow: {
                    visible: true,
                },
                headerFilter: { visible: true },
                paging: {
                    pageSize: 25
                },
                pager: {
                    showPageSizeSelector: true,
                    allowedPageSizes: [25, 50, 100]
                },
                selection: {
                    mode: "single"
                },
                grouping: {
                    autoExpandAll: true
                },
                headerFilter: {
                    visible: true
                },
                "export": {
                    enabled: true,
                    fileName: "RegistroClientes"+Date.now(),
                    allowExportSelectedData: true
                },
                columns: [
                    {
                        dataField: "inventoryId",
                        visible: false
                    },
                    {
                        dataField: "number",
                        caption: 'N°'
                    },
                    {
                        dataField: "referenceCode",
                        caption: 'Codigo de referencia'
                    },
                    {
                        dataField: "documentTitle",
                        caption: 'Título del documento'
                    },
                    {
                        dataField: "series",
                        caption: 'Serie'
                    },
                    {
                        dataField: "volumen",
                        caption: 'Tomo y/o '
                    },
                    {
                        dataField: "secondNumber",
                        caption: 'N°'
                    },
                    {
                        dataField: "extremeDates",
                        caption: 'Fechas extremas'
                    },
                    {
                        dataField: "installationUnit",
                        caption: 'Unidad de instalacion'
                    },
                    {
                        dataField: "numberSheets",
                        caption: 'Nº de folios'
                    },
                    {
                        dataField: "producerName",
                        caption: 'Nombre del productor'
                    },
                    {
                        dataField: "stateConservation",
                        caption: 'Estado de conservación'
                    },
                    {
                        dataField: "documentObservation",
                        caption: 'Observación del documento'
                    },
                    {
                        dataField: "shelf",
                        caption: 'Estante'
                    },
                    {
                        dataField: "bald",
                        caption: 'Balda'
                    },
                    {
                        dataField: "box",
                        caption: 'Nº Caja'
                    },
                    {
                        dataField: "Acciones",
                        caption: 'Acciones',
                        cellTemplate: function (container, options) {

                            var wrapper = $("<center>");
                            var DetailsContainer = $("<div>");
                            var EditContainer = $("<div>");
                            var DeleteContainer = $("<div>");

                            container.append(wrapper.append(DetailsContainer));

                            DetailsContainer.dxButton({
                                hint: 'Detalles',
                                type: "default",
                                icon: 'fa fa-list-alt',
                                width: 50,
                                onClick: function () {
                                    var url = "@Url.Action("Details","Inventory")/" + options.data['inventoryId'];
                                    window.location.href = url;
                                }
                            });

                            container.append(wrapper.append(EditContainer));

                            EditContainer.dxButton({
                                hint: 'Editar',
                                type: "default",
                                icon: 'fa fa-edit',
                                width: 50,
                                onClick: function () {
                                    var url = "@Url.Action("Edit","Inventory")/" + options.data['inventoryId'];
                                    window.location.href = url;
                                }
                            });

                            container.append(wrapper.append(DeleteContainer));

                            DeleteContainer.dxButton({
                                hint: 'Eliminar',
                                type: 'danger',
                                icon: 'fa fa-trash',
                                width: 50,
                                onClick: function () {
                                    var url = "@Url.Action("Delete","Inventory")/" + options.data['inventoryId'];
                                    window.location.href = url;
                                }
                            });

                        }
                    },
                    {
                        dataField: "Registros",
                        caption: 'Registros',
                        cellTemplate: function (container, options) {

                            var wrapper = $("<center>");
                            var IncomeContainer = $("<div>");
                            var OutflowContainer = $("<div>");

                            container.append(wrapper.append(IncomeContainer));

                            IncomeContainer.dxButton({
                                hint: 'Ingreso',
                                type: "default",
                                icon: 'fa fa-arrow-circle-left',
                                width: 50,
                                onClick: function () {
                                    var incomeData = {id: options.data.inventoryId, action: "Income"}
                                    movementModal(incomeData);
                                }
                            });

                            container.append(wrapper.append(OutflowContainer));

                            OutflowContainer.dxButton({
                                hint: 'Salida',
                                type: "default",
                                icon: 'fa fa-arrow-circle-right',
                                width: 50,
                                onClick: function () {
                                    var outflowData = {id: options.data.inventoryId, action: "Outflow"}
                                    movementModal(outflowData)
                                }
                            });
                        }
                    }
                ],
                //masterDetail: {
                //enabled: true,
                //    template: function (container, options)
                //    {
                //    var currentClientData = options.data;
                //        $("<div>")
                //            .addClass("master-detail-caption")
                //            .text("Visitas de " + currentClientData.firstName + " " + currentClientData.lastName)
                //            .appendTo(container);

                //        $("<div>")
                //            .dxDataGrid({
                //                columnAutoWidth: true,
                //                showBorders: true,
                //                columns: [
                //                {
                //                    dataField: "clientId",
                //                    visible: false
                //                },
                //                {
                //                    dataField: "visitRegistrationId",
                //                    visible: false
                //                },
                //                {
                //                    dataField: "visitDay",
                //                    caption: 'Fecha',
                //                    dataType: "date",
                //                    format: 'dd/MM/yyyy HH:mm:ss'
                //                },
                //                {
                //                    dataField: "departmentCode",
                //                    caption: 'Codigo Dpto'
                //                },
                //                {
                //                    dataField: "stateVisitStateValue",
                //                    caption: 'Estado'
                //                },
                //                {
                //                    dataField: "commisionerFullName",
                //                    caption: 'Comisionista Asignado'
                //                }
                //                ],
                //                dataSource: new DevExpress.data.DataSource({
                //                    store: new DevExpress.data.ArrayStore({
                //                        key: "visitRegistrationId",
                //                        data: dataSourceDetail
                //                    }),
                //                    filter: ["clientId", "=", options.key]
                //                })
                //            }).appendTo(container);
                //    }
                //}
            });
        });

    });
    </script>
    <script>
        function movementModal(data) {
            console.log(data);
            $("#MovementModal").modal();
            $("#Movement_InventoryId").val(data.id);
            $("#Movement_MovementType").val(data.action);
        }
    </script>

}